name: Build and test

on: push

env:
  build_dir: build
  build_config: Release
  cflags_gnuc: -Werror
  cflags_msvc: /WX
  test_target: ulib-test
  docs_target: ulib-docs

jobs:
  build:
    name: Build and test
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Configure runner
      run: |
        if [ $RUNNER_OS == 'Windows' ]; then
          echo 'cflags="${{env.cflags_msvc}}"' >> $GITHUB_ENV
          echo 'test_subdir=./${{env.build_config}}' >> $GITHUB_ENV
        else
          echo 'cflags="${{env.cflags_gnuc}}"' >> $GITHUB_ENV
          echo 'test_subdir=.' >> $GITHUB_ENV
        fi
      shell: bash

    - name: Configure CMake
      run: >
        cmake -B ${{env.build_dir}}
        -DULIB_LEAKS=ON
        -DCMAKE_SYSTEM_VERSION=''
        -DCMAKE_BUILD_TYPE=${{env.build_config}}
        -DCMAKE_C_FLAGS=${{env.cflags}}

    - name: Build
      run: >
        cmake --build ${{env.build_dir}}
        --config ${{env.build_config}}
        --target ${{env.test_target}}

    - name: Test
      working-directory: ${{env.build_dir}}/test
      run: ${{env.test_subdir}}/${{env.test_target}}

  docs:
    name: Generate the documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure runner
        run: |
          sudo apt install doxygen
          pip3 install -U Sphinx sphinx-rtd-theme breathe

      - name: Build docs
        run: |
          cmake -B ${{env.build_dir}}
          cmake --build ${{env.build_dir}} --target ${{env.docs_target}}
